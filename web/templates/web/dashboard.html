{% extends "web/_base.html" %}

{% block html_title %}NUAMX â€“ Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}
<div class="muted">Resumen operativo y accesos rÃ¡pidos.</div>
{% endblock %}

{% block extra_head %}
<style>
  .grid{display:grid;gap:14px}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width: 980px){ .grid-3{grid-template-columns:1fr} }

  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi .label{font-size:.9rem;color:#6b7280}
  .kpi .value{font-size:2rem;font-weight:800;color:#111;line-height:1.1}
  .kpi .meta{font-size:.85rem;color:#6b7280}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
  .muted{color:#6b7280}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid #f0f2f4}
  th{text-align:left;font-size:.9rem;color:#6b7280}
  td{font-size:.95rem}

  /* Botones ahora usan la paleta naranjo global */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:var(--nuamx);
    color:#fff;
    border-radius:10px;
    padding:10px 14px;
    font-weight:600;
    border:1px solid transparent;
  }
  .btn:hover{
    background:var(--nuamx-dark);
  }
  .btn-ghost{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:#fff;
    color:var(--nuamx);
    border:1px solid var(--nuamx);
    border-radius:10px;
    padding:10px 14px;
    font-weight:600;
  }

  .quick-grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width: 980px){ .quick-grid{grid-template-columns:1fr} }
  .quick-card{
    background:#fff;
    border:1px solid #e5e7eb;border-radius:12px;padding:14px;
    transition:.16s ease; position:relative; display:flex; gap:14px; align-items:center;
  }
  .quick-card:hover{transform:translateY(-2px); box-shadow:0 6px 22px rgba(0,0,0,.06)}
  .quick-icon{
    width:42px;height:42px; min-width:42px; border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:#FFF1E6; /* tono suave naranjo */
    font-size:22px;
  }
  .quick-title{font-weight:700}
  .quick-desc{font-size:.9rem;color:#6b7280}
  .quick-arrow{ position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:.35 }

  .chart-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
  .chart-title{font-weight:700;margin-bottom:8px}
  .chart-wrap{position:relative;height:280px}
</style>
{% endblock %}

{% block content %}

<div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
  <div class="muted">Inicio / Dashboard</div>
  <div style="display:flex;gap:8px">
    <a class="btn-ghost" href="#" onclick="exportCSV()" aria-label="Descargar CSV">Descargar CSV</a>
    <a class="btn" href="{% url 'carga-masiva' %}" aria-label="Nueva carga">Nueva carga</a>
  </div>
</div>

<section class="grid grid-3" style="margin-top:14px">
  <div class="card kpi">
    <div class="label">Registros totales</div>
    <div class="value" id="kpi-total">0</div>
    <div class="meta">Acumulado histÃ³rico</div>
  </div>
  <div class="card kpi">
    <div class="label">Errores en Ãºltimas cargas</div>
    <div class="value" id="kpi-errores" style="color:#b91c1c">0</div>
    <div class="meta">Ãšltimos procesos</div>
  </div>
  <div class="card kpi">
    <div class="label">Reportes generados</div>
    <div class="value" id="kpi-reportes">0</div>
    <div class="meta">PerÃ­odo reciente</div>
  </div>
</section>

<section class="grid grid-3" style="margin-top:14px">
  <div class="chart-card">
    <div class="chart-title">Registros por dÃ­a (Ãºltimos 14 dÃ­as)</div>
    <div class="chart-wrap">
      <canvas id="chartRegistros"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-title">Estados de proceso</div>
    <div class="chart-wrap">
      <canvas id="chartEstados"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-title">Tipo de carga</div>
    <div class="chart-wrap">
      <canvas id="chartTipos"></canvas>
    </div>
  </div>
</section>

<section class="card" style="margin-top:14px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px">
    <div class="muted">Ãšltimas cargas</div>
    <div style="display:flex;gap:8px">
      <a class="btn-ghost" href="{% url 'reportes' %}">Ver todo (CSV)</a>
      <button class="btn-ghost" type="button" onclick="location.reload()">Actualizar</button>
    </div>
  </div>

  <div style="overflow:auto">
    <table role="table" aria-label="Ãšltimas cargas">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Usuario</th>
          <th>Registros</th>
          <th>Tipo</th>
          <th>Observaciones</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>04-09-2025 10:12</td>
          <td>admin@nuamx.com</td>
          <td>1.200</td>
          <td>Carga masiva (XLSX)</td>
          <td>0 duplicados</td>
          <td>Completado</td>
        </tr>
        <tr>
          <td>03-09-2025 18:41</td>
          <td>analista@nuamx.com</td>
          <td>650</td>
          <td>Carga masiva (CSV)</td>
          <td>12 advertencias (montos)</td>
          <td>Advertencias</td>
        </tr>
        <tr>
          <td>02-09-2025 09:02</td>
          <td>admin@nuamx.com</td>
          <td>0</td>
          <td>Carga manual</td>
          <td>Error de formato</td>
          <td>Fallida</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card" style="margin-top:14px">
  <div class="quick-grid" role="list">
    <a class="quick-card" href="{% url 'carga-masiva' %}" role="listitem" aria-label="Cargar archivo">
      <div class="quick-icon">ðŸ“¤</div>
      <div class="quick-body">
        <div class="quick-title">Cargar archivo</div>
        <div class="quick-desc">Sube CSV/XLSX y valida antes de publicar.</div>
      </div>
      <div class="quick-arrow">âžœ</div>
    </a>

    <a class="quick-card" href="{% url 'busqueda' %}" role="listitem" aria-label="Buscar registros">
      <div class="quick-icon">ðŸ”Ž</div>
      <div class="quick-body">
        <div class="quick-title">Buscar registros</div>
        <div class="quick-desc">Filtra por RUT, perÃ­odo, estado y mÃ¡s.</div>
      </div>
      <div class="quick-arrow">âžœ</div>
    </a>

    <a class="quick-card" href="{% url 'reportes' %}" role="listitem" aria-label="Reportes">
      <div class="quick-icon">ðŸ“ˆ</div>
      <div class="quick-body">
        <div class="quick-title">Reportes</div>
        <div class="quick-desc">Descarga reportes diarios, semanales o mensuales.</div>
      </div>
      <div class="quick-arrow">âžœ</div>
    </a>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  // ===== Helpers Auth: intenta usar JWT si existe; si no, usa cookie de sesiÃ³n =====
  function getAccessToken(){
    const keys = ['nuamx_access','access','jwt_access','token'];
    for (const k of keys){
      let v = null;
      try{ v = localStorage.getItem(k); }catch(e){}
      if(v){ try{ return JSON.parse(v); } catch(e){ return (v||'').replace(/^"+|"+$/g,''); } }
    }
    // fallback cookie "access" (por si lo guardas asÃ­)
    const m = document.cookie.match(/(?:^|;\s*)access=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  function authHeaders(){
    const h = { "Accept":"application/json" };
    const t = getAccessToken();
    if (t) h["Authorization"] = "Bearer " + t;
    return h;
  }

  // ====== Estado de grÃ¡ficos (para reusar y actualizar) ======
  let lineChart = null, doughnutChart = null, barChart = null;

  function fmt(n){
    try{ return Number(n||0).toLocaleString('es-CL'); } catch(e){ return n; }
  }

  function drawOrUpdateCharts(payload){
    const serie = payload.registros_por_dia || [];
    const labels14 = serie.map(x => {
      const p = (x.date||'').split('-'); return p.length===3 ? `${p[2]}/${p[1]}` : x.date;
    });
    const dataRegistros = serie.map(x => x.count || 0);

    const est = payload.estados || {};
    const estadosData = [ est['VÃ¡lida']||0, est['Con advertencias']||0, est['Rechazada']||0 ];

    const tipos = payload.tipos || {};
    const tiposData = [ tipos['Factura']||0, tipos['Boleta']||0, tipos['Nota de crÃ©dito']||0, tipos['Otro']||0 ];

    // LÃ­nea
    if (!lineChart){
      lineChart = new Chart(document.getElementById('chartRegistros'), {
        type: 'line',
        data: { labels: labels14, datasets: [{ label:'Registros', data: dataRegistros, tension:.35, fill:true }]},
        options: { maintainAspectRatio:false, interaction:{mode:'index', intersect:false}, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}} }
      });
    } else {
      lineChart.data.labels = labels14;
      lineChart.data.datasets[0].data = dataRegistros;
      lineChart.update();
    }

    // Dona
    if (!doughnutChart){
      doughnutChart = new Chart(document.getElementById('chartEstados'), {
        type: 'doughnut',
        data: { labels:['Completado','Advertencias','Fallida'], datasets:[{ data: estadosData }] },
        options:{ maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    } else {
      doughnutChart.data.datasets[0].data = estadosData;
      doughnutChart.update();
    }

    // Barras
    if (!barChart){
      barChart = new Chart(document.getElementById('chartTipos'), {
        type: 'bar',
        data: { labels:['Factura','Boleta','Nota de crÃ©dito','Otro'], datasets:[{ label:'Registros', data: tiposData }] },
        options:{ maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    } else {
      barChart.data.datasets[0].data = tiposData;
      barChart.update();
    }
  }

  async function loadStats(){
    const r = await fetch("/api/calificaciones/stats/", {
      method: "GET",
      headers: authHeaders(),      // â¬…ï¸ ahora enviamos Bearer si existe
      credentials: "same-origin"   // â¬…ï¸ y cookie de sesiÃ³n si aplica
    });
    if(!r.ok) throw new Error("stats " + r.status);
    const data = await r.json();

    // KPIs
    document.getElementById('kpi-total').textContent   = fmt(data.total_registros || 0);
    document.getElementById('kpi-errores').textContent = fmt(data.errores_ultimos_14d || 0);
    // (si luego agregas conteo real de reportes al payload, lo pintas aquÃ­)
    document.getElementById('kpi-reportes').textContent = fmt(0);

    // GrÃ¡ficos
    drawOrUpdateCharts(data);
  }

  // Primera carga inmediata
  loadStats().catch(e => console.error(e));

  // ====== Tiempo real por sondeo (5 s) ======
  setInterval(() => {
    loadStats().catch(e => console.warn("Refresh stats:", e));
  }, 5000);

  // Dummy para el botÃ³n CSV
  window.exportCSV = function(){
    alert('AquÃ­ podrÃ­as descargar un CSV del tablero (placeholder).');
  }
})();
</script>
{% endblock %}
