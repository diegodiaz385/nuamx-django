<!doctype html>
<html lang="es">
<head>
  {% load static %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link rel="icon" href="{% static 'favicon.ico' %}">
  <title>{% block html_title %}NUAMX{% endblock %}</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ... (Estilos CSS) ... */
    :root{
      --nuamx:#0A6A3B; --nuamx-dark:#064F2C;
      --ink:#1F2937; --muted:#6B7280; --bg:#F8FAFC; --card:#FFFFFF; --border:#E5E7EB;
    }
    .btn{background:var(--nuamx);color:#fff;padding:.55rem 1rem;border-radius:.6rem;font-weight:600}
    .btn:hover{background:var(--nuamx-dark)}
    .btn-ghost{border:1px solid var(--border);padding:.5rem .9rem;border-radius:.6rem;background:#fff}
    .card{background:var(--card);border:1px solid var(--border);border-radius:1rem}
    .kpi .label{font-size:.8rem;color:var(--muted)}
    .kpi .value{font-size:1.6rem;font-weight:700}
    .nav a{display:block;padding:.6rem .9rem;border-radius:.6rem}
    .nav a.active{background:#F0FFF6;color:#064F2C;font-weight:600;border:1px solid #D1FAE5}
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-[color:var(--bg)] text-[color:var(--ink)]">
  <header class="h-16 bg-[color:var(--nuamx)] text-white flex items-center px-5 justify-between">
    <div class="font-semibold tracking-wide">NUAMX</div>
    <div class="flex items-center gap-3 text-sm">
      <div class="flex items-center gap-2">
        <span class="opacity-90">Moneda:</span>
        <select id="fx_selector" class="text-[color:#064F2C] bg-white/90 rounded px-2 py-1">
          <option value="CLP">CLP</option>
          <option value="COP">COP</option>
          <option value="PEN">PEN</option>
          <option value="USD">USD</option>
        </select>
      </div>

      <span id="user-email" class="opacity-90">user@nuamx.com</span>

      <a id="logout-btn" class="bg-white/15 px-3 py-1.5 rounded cursor-pointer">Salir</a>
    </div>
  </header>

  <div class="flex">
    <aside class="hidden md:block w-68 min-w-[260px] min-h-[calc(100vh-4rem)] bg-white border-r">
      <div class="p-4 text-xs uppercase tracking-wide text-[color:var(--muted)]">Menú</div>
      <nav class="nav px-3 pb-6 space-y-1">
        <a href="{% url 'dashboard' %}">Dashboard</a>
        <a href="{% url 'carga-manual' %}">Carga manual</a>
        <a href="{% url 'carga-masiva' %}">Carga masiva</a>
        <a href="{% url 'busqueda' %}">Búsqueda / Filtrado</a>
        <a href="{% url 'detalle' %}">Detalle / Edición</a>
        <a href="{% url 'reportes' %}">Reportes</a>
        <a href="{% url 'no-inscritos' %}">No inscritos</a>
        <a href="{% url 'admin-roles' %}">Usuarios / Roles</a>
      </nav>
    </aside>

    <main class="flex-1 p-6 md:p-8">
      <div class="text-sm text-[color:var(--muted)] mb-2">{% block breadcrumb %}Inicio / Sección{% endblock %}</div>

      <div class="mb-4">
        <h1 class="text-2xl font-semibold">
          {% block page_title %}Dashboard{% endblock %}
        </h1>
        {% block page_subtitle %}{% endblock %}
      </div>

      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    (function(){
      const links = document.querySelectorAll('.nav a');
      const path = location.pathname.replace(/\/+$/, '').split('/').pop() || 'dashboard'; 
      links.forEach(a => { 
          const hrefPath = a.getAttribute('href').replace(/\/+$/, '').split('/').pop();
          if (hrefPath === path) a.classList.add('active'); 
      });
    })();
  </script>

  <script>
    (function () {
      const loginUrl = "{% url 'login' %}";
      const tokenRefreshUrl = "{% url 'token_refresh' %}";

      const publicPaths = ['/login/', '/register/']; 
      const isPublic = publicPaths.some(p => location.pathname.startsWith(p));
      const access = localStorage.getItem('access');

      if (!isPublic && !access) {
        location.href = loginUrl; 
        return;
      }

      async function refreshTokenOnce() {
        const r = localStorage.getItem('refresh');
        if (!r) return null;
        const res = await fetch(tokenRefreshUrl, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh: r })
        });
        if (!res.ok) return null;
        const data = await res.json();
        if (data?.access) {
          localStorage.setItem('access', data.access);
          document.cookie = `access=${data.access}; Path=/; SameSite=Lax`;
          return data.access;
        }
        return null;
      }

      window.authFetch = async (url, opts = {}) => {
        const token = localStorage.getItem('access');
        opts.headers = Object.assign({}, opts.headers, { 'Authorization': 'Bearer ' + token });
        let res = await fetch(url, opts);
        if (res.status === 401) {
          const newToken = await refreshTokenOnce();
          if (newToken) {
            opts.headers['Authorization'] = 'Bearer ' + newToken;
            res = await fetch(url, opts);
          } else {
            forceLogout();
          }
        }
        return res;
      };

      const meData = JSON.parse(localStorage.getItem('me') || '{}');
      const emailEl = document.getElementById('user-email');
      if (emailEl && meData.email) emailEl.textContent = meData.email;

      function forceLogout() {
        localStorage.removeItem('access');
        localStorage.removeItem('refresh');
        localStorage.removeItem('me');
        document.cookie = 'access=; Max-Age=0; Path=/; SameSite=Lax';
        location.href = loginUrl; 
      }

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.addEventListener('click', forceLogout);
    })();
  </script>

  <script>
    (function(){
      const FX_LS_KEY = 'nuamx_fx_current';
      const FX_DEFAULT = 'CLP';

      const FX = (window.NUAMX_FX = window.NUAMX_FX || {
        rates: { CLP: 1, COP: 0.30, PEN: 220, USD: 950 },
        current: FX_DEFAULT
      });

      try {
        const saved = localStorage.getItem(FX_LS_KEY);
        if (saved) FX.current = saved.toUpperCase();
      } catch {}

      const fxSel = document.getElementById('fx_selector');
      if (fxSel) {
        fxSel.value = (FX.current || FX_DEFAULT).toUpperCase();
        fxSel.addEventListener('change', () => {
          FX.current = (fxSel.value || FX_DEFAULT).toUpperCase();
          try { localStorage.setItem(FX_LS_KEY, FX.current); } catch {}
          document.dispatchEvent(new CustomEvent('nuamx:fx-changed', { detail: { code: FX.current } }));
          document.dispatchEvent(new CustomEvent('nuamx:rebind-money'));
          document.querySelectorAll('.fx-label').forEach(el => el.textContent = FX.current);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.fx-label').forEach(el => el.textContent = (FX.current || FX_DEFAULT).toUpperCase());
      });

      window.fxSupportsCents = function(code){
        const c = String(code||FX.current||FX_DEFAULT).toUpperCase();
        return (c === 'USD' || c === 'PEN');
      };

      window.fxFormat = function(amount, code){
        const c = (code || FX.current || FX_DEFAULT).toUpperCase();
        const hasCents = window.fxSupportsCents(c);
        return new Intl.NumberFormat('es-CL', {
          minimumFractionDigits: hasCents ? 2 : 0,
          maximumFractionDigits: hasCents ? 2 : 0
        }).format(Number(amount||0));
      };

      window.fxConvertBetween = function(n, fromCode, toCode){
        const fx = FX.rates || {};
        const from = (fromCode||FX.current||FX_DEFAULT).toUpperCase();
        const to   = (toCode||FX_DEFAULT).toUpperCase();
        const clp = Number(n||0) * (fx[from] || 1);
        return clp / (fx[to] || 1);
      };

      function digitIndexLeftOfCaret(value, caret){
        let count = 0;
        for(let i=0;i<Math.min(caret, value.length); i++){
          if(/\d/.test(value[i])) count++;
        }
        return count;
      }
      function setCaretByDigitIndex(input, k){
        const v = input.value;
        let seen = 0, pos = v.length;
        for(let i=0;i<v.length;i++){
          if(/\d/.test(v[i])) seen++;
          if(seen >= k){ pos = i+1; break; }
        }
        try{ input.setSelectionRange(pos, pos); }catch(e){}
      }

      function parseMaskedAuto(value, allowDecimals){
        const raw = String(value || '');
        if(!allowDecimals){
          const digits = raw.replace(/[^\d]/g,'');
          return digits ? parseInt(digits,10) : 0;
        }
        const lastSep = Math.max(raw.lastIndexOf(','), raw.lastIndexOf('.'));
        if(lastSep<0){
          const digits = raw.replace(/[^\d]/g,'');
          return digits ? parseInt(digits,10) : 0;
        }
        const left  = raw.slice(0,lastSep).replace(/[^\d]/g,'');
        const right = raw.slice(lastSep+1).replace(/[^\d]/g,'').slice(0,2);
        const intN  = left?parseInt(left,10):0;
        const fracN = right?parseInt(right,10)/Math.pow(10,right.length):0;
        return intN+fracN;
      }

      function formatMaskedAuto(n, cur, forceTwoDec){
        if(!window.fxSupportsCents(cur)){
          return new Intl.NumberFormat('es-CL', {minimumFractionDigits:0, maximumFractionDigits:0}).format(n);
        }
        if(forceTwoDec){
          return new Intl.NumberFormat('es-CL', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
        }
        return new Intl.NumberFormat('es-CL', {minimumFractionDigits:0, maximumFractionDigits:2}).format(n);
      }

      function bindMoneyInput(el){
        function liveMask(){
          const cur = (FX.current||FX_DEFAULT).toUpperCase();
          const allowDec = window.fxSupportsCents(cur);

          const oldVal = el.value;
          const caret  = el.selectionStart ?? oldVal.length;
          const kDigitsLeft = digitIndexLeftOfCaret(oldVal, caret);

          let n = parseMaskedAuto(oldVal, allowDec);
          if(allowDec){
            n = Math.floor(n * 100) / 100;
          }else{
            n = Math.trunc(n);
          }

          const newVal = formatMaskedAuto(n, cur, false);
          if(newVal !== oldVal){
            el.value = newVal;
            const totalDigits = (newVal.match(/\d/g)||[]).length;
            const k = Math.min(Math.max(kDigitsLeft, 0), totalDigits);
            setCaretByDigitIndex(el, k);
          }
        }
        function onBlur(){
          const cur = (FX.current||FX_DEFAULT).toUpperCase();
          const allowDec = window.fxSupportsCents(cur);
          let n = parseMaskedAuto(el.value, allowDec);
          if(allowDec){
            n = Math.round(n * 100) / 100;
            el.value = formatMaskedAuto(n, cur, true);
          }else{
            n = Math.trunc(n);
            el.value = formatMaskedAuto(n, cur, false);
          }
        }
        el.removeEventListener('input', el.__money_input_listener__);
        el.removeEventListener('blur', el.__money_blur_listener__);
        el.__money_input_listener__ = liveMask;
        el.__money_blur_listener__  = onBlur;
        el.addEventListener('input', liveMask);
        el.addEventListener('blur', onBlur);
        // Inicial
        setTimeout(liveMask, 0);
      }

      function rebindAllMoneyInputs(){
        document.querySelectorAll('input.money-input').forEach(bindMoneyInput);
        document.querySelectorAll('.fx-label').forEach(el => el.textContent = (FX.current||FX_DEFAULT).toUpperCase());
      }

      document.addEventListener('DOMContentLoaded', rebindAllMoneyInputs);
      document.addEventListener('nuamx:rebind-money', rebindAllMoneyInputs);
      document.addEventListener('nuamx:fx-changed', rebindAllMoneyInputs);
    })();
  </script>
  
  <script src="{% static 'app.js' %}?v=5"></script>
  {% block extra_js %}{% endblock %}
</body>
</html>