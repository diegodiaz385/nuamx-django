<!doctype html>
<html lang="es">
<head>
  {% load static %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link rel="icon" href="{% static 'favicon.ico' %}">
  <title>{% block html_title %}NUAMX{% endblock %}</title>

  <!-- === Debe ir PRIMERO para asegurar Authorization/credenciales en cualquier request temprana === -->
  <script src="{% static 'preauth-guard.js' %}"></script>

  <!-- Librer√≠as de estilo -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      /* Colores base NUAMX (ahora naranjo) */
      --nuamx:#FF4500;
      --nuamx-dark:#CC3700;

      --ink:#1F2937;
      --muted:#6B7280;
      --bg:#F8FAFC;
      --card:#FFFFFF;
      --border:#E5E7EB;
    }
    .btn{
      background:var(--nuamx);
      color:#fff;
      padding:.55rem 1rem;
      border-radius:.6rem;
      font-weight:600;
    }
    .btn:hover{background:var(--nuamx-dark)}
    .btn-ghost{
      border:1px solid var(--border);
      padding:.5rem .9rem;
      border-radius:.6rem;
      background:#fff;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:1rem;
    }
    .kpi .label{
      font-size:.8rem;
      color:var(--muted);
    }
    .kpi .value{
      font-size:1.6rem;
      font-weight:700;
    }
    .nav a{
      display:block;
      padding:.6rem .9rem;
      border-radius:.6rem;
    }
    /* Estado activo del men√∫ en tonos naranjo */
    .nav a.active{
      background:#FFF1E6;
      color:#CC3700;
      font-weight:600;
      border:1px solid #FED7C2;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-[color:var(--bg)] text-[color:var(--ink)]">
  <header class="h-16 bg-[color:var(--nuamx)] text-white flex items-center px-5 justify-between">
    <div class="font-semibold tracking-wide">NUAMX</div>
    <div class="flex items-center gap-3 text-sm">
      <!-- Selector de moneda eliminado -->
      <span id="user-email" class="opacity-90">user@nuamx.com</span>
      <a id="logout-btn" class="bg-white/15 px-3 py-1.5 rounded cursor-pointer">Salir</a>
    </div>
  </header>

  <div class="flex">
    <aside class="hidden md:block w-68 min-w-[260px] min-h-[calc(100vh-4rem)] bg-white border-r">
      <div class="p-4 text-xs uppercase tracking-wide text-[color:var(--muted)]">Men√∫</div>
      <nav class="nav px-3 pb-6 space-y-1">
        <a href="{% url 'dashboard' %}">Dashboard</a>
        <a href="{% url 'carga-manual' %}">Carga manual</a>
        <a href="{% url 'carga-masiva' %}">Carga masiva</a>
        <a href="{% url 'busqueda' %}">B√∫squeda / Filtrado</a>
        <a href="{% url 'detalle' %}">Detalle / Edici√≥n</a>
        <a href="{% url 'reportes' %}">Reportes</a>
        <a href="/indicadores/" style="color: #d97706; font-weight: 700;">
            üìä Indicadores (Micro Servicios)
        </a>
        <a href="{% url 'no-inscritos' %}">No inscritos</a>
        <a id="nav-admin-roles" href="{% url 'admin-roles' %}">Usuarios / Roles</a>
      </nav>
    </aside>

    <main class="flex-1 p-6 md:p-8">
      <div class="text-sm text-[color:var(--muted)] mb-2">
        {% block breadcrumb %}Inicio / Secci√≥n{% endblock %}
      </div>

      <div class="mb-4">
        <h1 class="text-2xl font-semibold">
          {% block page_title %}Dashboard{% endblock %}
        </h1>
        {% block page_subtitle %}{% endblock %}
      </div>

      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- ===== JS n√∫cleo de la app (cargado DESPU√âS del preauth-guard y ANTES de scripts inline) ===== -->
  <script src="{% static 'app.js' %}"></script>

  <!-- Marca activa en men√∫ -->
  <script>
    (function(){
      const links = document.querySelectorAll('.nav a');
      const path = location.pathname.replace(/\/+$/, '').split('/').pop() || 'dashboard';
      links.forEach(a => {
        const hrefPath = a.getAttribute('href').replace(/\/+$/, '').split('/').pop();
        if (hrefPath === path) a.classList.add('active');
      });
    })();
  </script>

  <!-- Auth + /api/me + guardia force-password + visibilidad men√∫ -->
  <script>
    (function () {
      const loginUrl        = "{% url 'login' %}";
      const tokenRefreshUrl = "{% url 'token_refresh' %}";
      const apiMeUrl        = "{% url 'api_me' %}";
      const forceUrl        = "{% url 'force_password' %}";

      const path        = location.pathname;
      const publicPaths = ['/login/', '/register/'];
      const isPublic    = publicPaths.some(p => path.startsWith(p));
      const isForcePage = path.startsWith('/force-password/');
      const access      = localStorage.getItem('access');

      if (!isPublic && !isForcePage && !access) {
        location.href = loginUrl;
        return;
      }

      async function refreshTokenOnce() {
        const r = localStorage.getItem('refresh');
        if (!r) return null;
        const res = await fetch(tokenRefreshUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh: r })
        });
        if (!res.ok) return null;
        const data = await res.json();
        if (data?.access) {
          localStorage.setItem('access', data.access);
          document.cookie = `access=${data.access}; Path=/; SameSite=Lax`;
          return data.access;
        }
        return null;
      }

      // Nota: app.js ya define window.authFetch con refresh; mantenemos compat aqu√≠
      window.authFetch = async (url, opts = {}) => {
        const token = localStorage.getItem('access');
        opts.headers = Object.assign({}, opts.headers, { 'Authorization': 'Bearer ' + token });
        let res = await fetch(url, opts);
        if (res.status === 401) {
          const newToken = await refreshTokenOnce();
          if (newToken) {
            opts.headers['Authorization'] = 'Bearer ' + newToken;
            res = await fetch(url, opts);
          } else {
            forceLogout();
          }
        }
        return res;
      };

      (async ()=> {
        if (isPublic) return;

        try{
          const res = await (window.authFetch ? authFetch(apiMeUrl) : fetch(apiMeUrl));
          if (!res.ok) return;

          const me = await res.json();
          try { localStorage.setItem('me', JSON.stringify(me)); } catch {}

          const emailEl = document.getElementById('user-email');
          if (emailEl && me.email) emailEl.textContent = me.email;

          if (me.must_change_password && !isForcePage) {
            location.href = forceUrl;
            return;
          }

          const navItem = document.getElementById('nav-admin-roles');
          if (navItem){
            const roleStr = String(me.role || me.rol || me.role_name || "").toLowerCase();
            const groups  = Array.isArray(me.groups) ? me.groups.map(g => (typeof g==="string"?g:(g?.name||""))).join(" ").toLowerCase() : "";
            const isSuper = (me.is_superuser === true) || String(me.is_superuser).toLowerCase()==="true";
            const isStaff = (me.is_staff === true)     || String(me.is_staff).toLowerCase()==="true";

            const explicitAuditor = /(^|\b)(auditor)\b/.test(roleStr) || /\bauditor\b/.test(groups);
            const explicitUsuario = /(^|\b)(usuario|user)\b/.test(roleStr) || /\busuario\b|\buser\b/.test(groups);

            const canSee = isSuper || isStaff ||
                           /\b(administrador|admin)\b/.test(roleStr) || /\boperador|oper\b/.test(roleStr) ||
                           /\b(administrador|admin|operador|oper)\b/.test(groups);

            if (!canSee && (explicitAuditor || explicitUsuario)) {
              navItem.parentElement.removeChild(navItem);
            }
          }
        }catch(_){}
      })();

      function forceLogout() {
        localStorage.removeItem('access');
        localStorage.removeItem('refresh');
        localStorage.removeItem('me');
        document.cookie = 'access=; Max-Age=0; Path=/; SameSite=Lax';
        location.href = loginUrl;
      }

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.addEventListener('click', forceLogout);
    })();
  </script>

  <!-- ===== Sistema FX global (NO QUITADO) ===== -->
  <script>
    (function(){
      const FX_LS_KEY = 'nuamx_fx_current';
      const FX_DEFAULT = 'CLP';

      const FX = (window.NUAMX_FX = window.NUAMX_FX || {
        rates: { CLP:1, USD:971, PEN:288, COP:0.257 },
        current: FX_DEFAULT
      });

      try {
        const saved = localStorage.getItem(FX_LS_KEY);
        if (saved) FX.current = saved.toUpperCase();
      } catch {}

      const fxSel = document.getElementById('fx_selector');
      if (fxSel) {
        fxSel.value = (FX.current || FX_DEFAULT).toUpperCase();
        fxSel.addEventListener('change', () => {
          FX.current = (fxSel.value || FX_DEFAULT).toUpperCase();
          try { localStorage.setItem(FX_LS_KEY, FX.current); } catch {}
          document.dispatchEvent(new CustomEvent('nuamx:fx-changed', { detail: { code: FX.current } }));
          document.dispatchEvent(new CustomEvent('nuamx:rebind-money'));
          document.querySelectorAll('.fx-label').forEach(el => el.textContent = FX.current);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.fx-label').forEach(el => el.textContent = (FX.current || FX_DEFAULT).toUpperCase());
      });

      window.fxSupportsCents = function(code){
        const c = String(code||FX.current||FX_DEFAULT).toUpperCase();
        return (c === 'USD' || c === 'PEN');
      };

      window.fxFormat = function(amount, code){
        const c = (code || FX.current || FX_DEFAULT).toUpperCase();
        const hasCents = window.fxSupportsCents(c);
        return new Intl.NumberFormat('es-CL', {
          minimumFractionDigits: hasCents ? 2 : 0,
          maximumFractionDigits: hasCents ? 2 : 0
        }).format(Number(amount||0));
      };

      window.fxConvertBetween = function(n, fromCode, toCode){
        const fx = FX.rates || {};
        const from = (fromCode||FX.current||FX_DEFAULT).toUpperCase();
        const to   = (toCode||FX_DEFAULT).toUpperCase();
        const clp = Number(n||0) * (fx[from] || 1);
        return clp / (fx[to] || 1);
      };

      function digitIndexLeftOfCaret(value, caret){
        let count = 0;
        for(let i=0;i<Math.min(caret, value.length); i++){
          if(/\d/.test(value[i])) count++;
        }
        return count;
      }
      function setCaretByDigitIndex(input, k){
        const v = input.value;
        let seen = 0, pos = v.length;
        for(let i=0;i<v.length;i++){
          if(/\d/.test(v[i])) seen++;
          if(seen >= k){ pos = i+1; break; }
        }
        try{ input.setSelectionRange(pos, pos); }catch(e){}
      }

      function parseMaskedAuto(value, allowDecimals){
        const raw = String(value || '');
        if(!allowDecimals){
          const digits = raw.replace(/[^\d]/g,'');
          return digits ? parseInt(digits,10) : 0;
        }
        const lastSep = Math.max(raw.lastIndexOf(','), raw.lastIndexOf('.'));
        if(lastSep<0){
          const digits = raw.replace(/[^\d]/g,'');
          return digits ? parseInt(digits,10) : 0;
        }
        const left  = raw.slice(0,lastSep).replace(/[^\d]/g,'');
        const right = raw.slice(lastSep+1).replace(/[^\d]/g,'').slice(0,2);
        const intN  = left?parseInt(left,10):0;
        const fracN = right?parseInt(right,10)/Math.pow(10,right.length):0;
        return intN+fracN;
      }

      function formatMaskedAuto(n, cur, forceTwoDec){
        if(!window.fxSupportsCents(cur)){
          return new Intl.NumberFormat('es-CL', {minimumFractionDigits:0, maximumFractionDigits:0}).format(n);
        }
        if(forceTwoDec){
          return new Intl.NumberFormat('es-CL', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
        }
        return new Intl.NumberFormat('es-CL', {minimumFractionDigits:0, maximumFractionDigits:2}).format(n);
      }

      function bindMoneyInput(el){
        function liveMask(){
          const cur = (FX.current||FX_DEFAULT).toUpperCase();
          const allowDec = window.fxSupportsCents(cur);

          const oldVal = el.value;
          const caret  = el.selectionStart ?? oldVal.length;
          const kDigitsLeft = digitIndexLeftOfCaret(oldVal, caret);

          let n = parseMaskedAuto(oldVal, allowDec);
          if(allowDec){ n = Math.floor(n * 100) / 100; }
          else{ n = Math.trunc(n); }

          const newVal = formatMaskedAuto(n, cur, false);
          if(newVal !== oldVal){
            el.value = newVal;
            const totalDigits = (newVal.match(/\d/g)||[]).length;
            const k = Math.min(Math.max(kDigitsLeft, 0), totalDigits);
            setCaretByDigitIndex(el, k);
          }
        }
        function onBlur(){
          const cur = (FX.current||FX_DEFAULT).toUpperCase();
          const allowDec = window.fxSupportsCents(cur);
          let n = parseMaskedAuto(el.value, allowDec);
          if(allowDec){
            n = Math.round(n * 100) / 100;
            el.value = formatMaskedAuto(n, cur, true);
          }else{
            n = Math.trunc(n);
            el.value = formatMaskedAuto(n, cur, false);
          }
        }
        el.removeEventListener('input', el.__money_input_listener__);
        el.removeEventListener('blur', el.__money_blur_listener__);
        el.__money_input_listener__ = liveMask;
        el.__money_blur_listener__  = onBlur;
        el.addEventListener('input', liveMask);
        el.addEventListener('blur', onBlur);
        setTimeout(liveMask, 0);
      }

      function rebindAllMoneyInputs(){
        document.querySelectorAll('input.money-input').forEach(bindMoneyInput);
        document.querySelectorAll('.fx-label').forEach(el => el.textContent = (FX.current||FX_DEFAULT).toUpperCase());
      }

      document.addEventListener('DOMContentLoaded', rebindAllMoneyInputs);
      document.addEventListener('nuamx:rebind-money', rebindAllMoneyInputs);
      document.addEventListener('nuamx:fx-changed', rebindAllMoneyInputs);

      // Exponer helpers para vistas
      window.NUAMX_MONEY = {
        bindMoneyInput, rebindAllMoneyInputs, parseMaskedAuto, formatMaskedAuto
      };
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
