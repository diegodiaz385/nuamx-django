{% extends "web/_base.html" %}

{% block page_title %}Carga masiva{% endblock %}
{% block page_subtitle %}Sube varias calificaciones de una sola vez (v√≠a API).{% endblock %}

{% block content %}
<style>
  .card-pad{ padding: 1.25rem; }
  .muted{ color: var(--muted); }
  .toolbar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .toolbar .mono-pill{
    border:1px solid var(--border); background:#fff; border-radius:.6rem;
    padding:.45rem .6rem; min-height:38px; display:inline-flex; align-items:center;
  }
  .toolbar .mono-pill select{ border:0; outline:0; background:transparent; pointer-events:none; }
  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; }

  .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:.75rem; }
  table.wfull{ width:100%; border-collapse:collapse; font-size:.94rem; }
  thead th{ background:#f8fafc; font-weight:600; position:sticky; top:0; z-index:1; }
  th,td{ padding:.65rem .75rem; border-bottom:1px solid var(--border); text-align:left; }
  th:nth-child(1){ min-width:120px }
  th:nth-child(2){ min-width:200px }
  th:nth-child(3){ min-width:110px }
  th:nth-child(4){ min-width:160px }
  th:nth-child(5){ min-width:120px }
  th:nth-child(6){ min-width:140px }
  th:nth-child(7){ min-width:160px }
  th:nth-child(8){ min-width:220px }
  th:nth-child(9){ min-width:110px }

  .cell-input{
    width:100%; border:1px solid var(--border); background:#fff;
    border-radius:.5rem; padding:.45rem .6rem; min-height:38px;
  }
  .cell-input--sm{ min-height:36px; padding:.35rem .55rem; }
</style>

<section class="space-y-6">
  <div class="card card-pad">
    <h2 class="text-base font-semibold m-0">Plantilla editable</h2>
    <p class="muted" style="margin:.25rem 0 1rem 0">
      Columnas: <b>RUT</b>, <b>Raz√≥n social</b>, <b>Per√≠odo</b>, <b>Tipo</b>, <b>Folio</b>, <b>Monto (<span class="fx-label"></span>)</b>, <b>Estado</b>, <b>Observaciones</b>.
    </p>

    <div class="toolbar" style="margin-bottom:12px">
      <span class="muted">Moneda:</span>
      <!-- Solo display de la moneda (sin cambiar aqu√≠). Se sincroniza con #fx_selector (navbar). -->
      <span class="mono-pill">
        <select id="cmv_currency_display">
          <option>CLP</option><option>USD</option><option>PEN</option><option>COP</option>
        </select>
      </span>

      <div class="btn-row" style="margin-left:auto">
        <button id="cmv_add" class="btn-ghost" type="button">‚ûï Agregar fila</button>
        <button id="cmv_validate" class="btn" type="button">‚úÖ Validar</button>
        <button id="cmv_export" class="btn-ghost" type="button">üì• Exportar CSV</button>
        <button id="cmv_push" class="btn" type="button">üì§ Subir a API</button>
      </div>
    </div>

    <div class="table-wrap">
      <table class="wfull" id="cmv_table">
        <thead>
          <tr>
            <th>RUT</th>
            <th>Raz√≥n social</th>
            <th>Per√≠odo</th>
            <th>Tipo</th>
            <th>Folio</th>
            <th>Monto (<span class="fx-label"></span>)</th>
            <th>Estado</th>
            <th>Observaciones</th>
            <th>‚Äî</th>
          </tr>
        </thead>
        <tbody id="cmv_tbody">
          <!-- Fila inicial -->
        </tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:10px">
      Formato de <b>Per√≠odo</b>: YYYY-MM. El <b>Monto</b> se m√°scara autom√°ticamente con separadores de miles seg√∫n la moneda activa.
    </p>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
try{
(function(){
  const $ = (s,c=document)=>c.querySelector(s);
  const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));

  // --- Moneda global (del navbar). Si no existe, CLP.
  function getCur(){ return (window.NUAMX_FX && window.NUAMX_FX.current) ? window.NUAMX_FX.current : 'CLP'; }
  function supportsCents(code){ const c=(code||'').toUpperCase(); return (c==='USD'||c==='PEN'); }
  function refreshFxLabels(){
    const cur = getCur();
    $$('.fx-label').forEach(el=> el.textContent = cur);
    const disp = $('#cmv_currency_display');
    if(disp){
      for(const o of disp.options){ o.selected = (o.text === cur); }
    }
  }
  refreshFxLabels();
  document.getElementById('fx_selector')?.addEventListener('change', ()=>{
    refreshFxLabels();
    reformatAllMontos();
  });

  // ===== helpers caret =====
  function digitIndexLeftOfCaret(value, caret){
    let count = 0;
    for(let i=0;i<Math.min(caret, value.length); i++){
      if(/\d/.test(value[i])) count++;
    }
    return count;
  }
  function setCaretByDigitIndex(input, k){
    const v = input.value;
    let seen = 0, pos = v.length;
    for(let i=0;i<v.length;i++){
      if(/\d/.test(v[i])) seen++;
      if(seen >= k){ pos = i+1; break; }
    }
    requestAnimationFrame(()=>{ try{ input.setSelectionRange(pos,pos); }catch(e){} });
  }

  // ===== parse/format robusto =====
  // S√≥lo permitimos decimales si la moneda lo admite Y el usuario us√≥ , o .
  function parseMaskedStrict(value, allowDecimals, userWantsDecimals){
    const raw = String(value||'');
    if(!allowDecimals || !userWantsDecimals){
      const digits = raw.replace(/[^\d]/g,'');
      return digits ? parseInt(digits,10) : 0;
    }
    const lastSep = Math.max(raw.lastIndexOf(','), raw.lastIndexOf('.'));
    if(lastSep < 0){
      const digits = raw.replace(/[^\d]/g,'');
      return digits ? parseInt(digits,10) : 0;
    }
    const left  = raw.slice(0,lastSep).replace(/[^\d]/g,'');
    const right = raw.slice(lastSep+1).replace(/[^\d]/g,'').slice(0,2);
    const intN  = left ? parseInt(left,10) : 0;
    const fracN = right ? parseInt(right,10)/Math.pow(10,right.length) : 0;
    return intN + fracN;
  }
  function formatMasked(n, cur, forceTwoDec){
    if(!supportsCents(cur)){
      return new Intl.NumberFormat('es-CL',{minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
    }
    if(forceTwoDec){
      return new Intl.NumberFormat('es-CL',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
    }
    return new Intl.NumberFormat('es-CL',{minimumFractionDigits:0,maximumFractionDigits:2}).format(n);
  }

  // ====== FOLIO (F-) ======
  function ensureFPrefix(input){
    if(!input) return;
    if(input.value==='' || input.value==='F-'){ input.value='F-'; }
    else { input.value = input.value.replace(/^([fF]-?)+/,'F-'); }
    const len = input.value.length;
    try{ input.setSelectionRange(len,len); }catch(e){}
  }
  function bindFolio(input){
    if(!input || input.dataset.folioBound==='1') return;
    input.dataset.folioBound='1';
    input.addEventListener('focus', ()=> ensureFPrefix(input));
    input.addEventListener('keydown', (e)=>{
      if(e.key===' '||e.code==='Space'){ e.preventDefault(); ensureFPrefix(input); }
    });
    input.addEventListener('input', ()=>{
      if(input.value!==''){ input.value = input.value.replace(/^([fF]-?)+/,'F-'); }
    });
    input.addEventListener('blur', ()=>{ if(input.value.trim()==='') input.value='F-'; });
  }

  // ====== MONTO (m√°scara) ======
  function wantsDecimalsForInput(input){ return input?.dataset?.hadDecimal==='1'; }
  function setWantsDecimalsForInput(input, flag){
    if(!input) return;
    if(flag) input.dataset.hadDecimal='1';
    else delete input.dataset.hadDecimal;
  }
  function bindMonto(input){
    if(!input || input.dataset.montoBound==='1') return;
    input.dataset.montoBound='1';

    input.addEventListener('keydown', (e)=>{
      if(e.key===','||e.key==='.' ){
        const cur=getCur(); if(supportsCents(cur)) setWantsDecimalsForInput(input,true);
      }
    });
    input.addEventListener('paste', (e)=>{
      const t=(e.clipboardData?.getData('text')||'');
      if(/[,.]/.test(t)){ const cur=getCur(); if(supportsCents(cur)) setWantsDecimalsForInput(input,true); }
    });

    function liveMask(){
      const cur=getCur();
      const allowDec=supportsCents(cur);
      const oldVal=input.value;
      const caret=input.selectionStart ?? oldVal.length;
      const wasEnd=(caret===oldVal.length);
      const kDigitsLeft=digitIndexLeftOfCaret(oldVal, caret);

      let n=parseMaskedStrict(oldVal, allowDec, wantsDecimalsForInput(input));
      if(allowDec){ n=Math.floor(n*100)/100; } else { n=Math.trunc(n); }

      const newVal=formatMasked(n, cur, false);
      if(newVal!==oldVal){
        input.value=newVal;
        requestAnimationFrame(()=>{
          if(wasEnd){ const end=input.value.length; try{ input.setSelectionRange(end,end);}catch(e){} }
          else{
            const totalDigits=(newVal.match(/\d/g)||[]).length;
            const k=Math.min(Math.max(kDigitsLeft,0),totalDigits);
            setCaretByDigitIndex(input, k);
          }
        });
      }
    }
    function onBlur(){
      const cur=getCur();
      const allowDec=supportsCents(cur);
      let n=parseMaskedStrict(input.value, allowDec, wantsDecimalsForInput(input));
      if(allowDec){ n=Math.round(n*100)/100; input.value=formatMasked(n, cur, true); }
      else{ n=Math.trunc(n); input.value=formatMasked(n, cur, false); }
    }

    input.addEventListener('input', liveMask);
    input.addEventListener('blur', onBlur);
    setTimeout(liveMask, 50);
  }
  function reformatAllMontos(){
    $$('#cmv_tbody input[data-col="monto"]').forEach(inp=>{
      if(!supportsCents(getCur())) setWantsDecimalsForInput(inp,false);
      inp.dispatchEvent(new Event('input',{bubbles:true}));
      inp.dispatchEvent(new Event('blur',{bubbles:true}));
    });
    refreshFxLabels();
  }

  // ====== render fila ======
  function makeRow(data={}){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="cell-input" data-col="rut" value="${data.rut||''}" placeholder="11.111.111-1"></td>
      <td><input class="cell-input" data-col="razon_social" value="${data.razon_social||''}" placeholder="Empresa SpA"></td>
      <td><input class="cell-input cell-input--sm" data-col="periodo" value="${data.periodo||''}" placeholder="YYYY-MM"></td>
      <td>
        <select class="cell-input" data-col="tipo_instrumento">
          <option value="">Selecciona‚Ä¶</option>
          <option ${data.tipo_instrumento==='Factura'?'selected':''}>Factura</option>
          <option ${data.tipo_instrumento==='Boleta'?'selected':''}>Boleta</option>
          <option ${data.tipo_instrumento==='Nota de cr√©dito'?'selected':''}>Nota de cr√©dito</option>
        </select>
      </td>
      <td><input class="cell-input cell-input--sm" data-col="folio" value="${data.folio||'F-'}" placeholder="F-12345"></td>
      <td><input class="cell-input" data-col="monto" inputmode="decimal" value="${data.monto||'0'}"></td>
      <td>
        <select class="cell-input" data-col="estado_validacion">
          <option value="">Selecciona‚Ä¶</option>
          <option ${data.estado_validacion==='V√°lida'?'selected':''}>V√°lida</option>
          <option ${data.estado_validacion==='Con advertencias'?'selected':''}>Con advertencias</option>
          <option ${data.estado_validacion==='Rechazada'?'selected':''}>Rechazada</option>
        </select>
      </td>
      <td><input class="cell-input" data-col="observaciones" value="${data.observaciones||''}" placeholder="Notas‚Ä¶"></td>
      <td><button class="btn-ghost" data-del type="button">Eliminar</button></td>
    `;
    // binds
    const folio = tr.querySelector('[data-col="folio"]'); bindFolio(folio);
    const monto = tr.querySelector('[data-col="monto"]'); bindMonto(monto);
    tr.querySelector('[data-del]')?.addEventListener('click', ()=> tr.remove());
    return tr;
  }

  // Fila inicial
  $('#cmv_tbody').appendChild(makeRow({}));

  // Botones cabecera
  $('#cmv_add')?.addEventListener('click', ()=> $('#cmv_tbody').appendChild(makeRow({})));
  $('#cmv_validate')?.addEventListener('click', ()=>{
    // validaciones m√≠nimas
    const rows = $$('#cmv_tbody tr');
    let errs=0;
    for(const tr of rows){
      const val=(c)=> tr.querySelector(`[data-col="${c}"]`)?.value?.trim() || '';
      if(!val('rut') || !val('periodo') || !val('tipo_instrumento') || !val('folio') || !val('monto')){
        errs++;
      }
    }
    if(errs) alert(`Hay ${errs} fila(s) con campos obligatorios vac√≠os.`);
    else alert('Todo OK para enviar.');
  });

  $('#cmv_export')?.addEventListener('click', ()=>{
    const rows=$$('#cmv_tbody tr');
    const cur=getCur();
    const allowDec=(cur==='USD'||cur==='PEN');
    const parseForCSV=(v)=>{
      const raw=String(v||'');
      if(!allowDec){ const d=raw.replace(/[^\d]/g,''); return d?parseInt(d,10):0; }
      const lastSep=Math.max(raw.lastIndexOf(','),raw.lastIndexOf('.'));
      if(lastSep<0){ const d=raw.replace(/[^\d]/g,''); return d?parseInt(d,10):0; }
      const L=raw.slice(0,lastSep).replace(/[^\d]/g,'');
      const R=raw.slice(lastSep+1).replace(/[^\d]/g,'').slice(0,2);
      const i=L?parseInt(L,10):0; const f=R?parseInt(R,10)/Math.pow(10,R.length):0;
      return +(i+f).toFixed(2);
    };
    const data=[['rut','razon_social','periodo','tipo_instrumento','folio','monto','moneda','estado_validacion','observaciones']];
    for(const tr of rows){
      const val=(c)=> tr.querySelector(`[data-col="${c}"]`)?.value?.trim() || '';
      data.push([
        val('rut'), val('razon_social'), val('periodo'), val('tipo_instrumento'),
        val('folio'), parseForCSV(val('monto')), cur, val('estado_validacion'), val('observaciones')
      ]);
    }
    const csv=data.map(r=>r.map(s=>{
      const t=String(s); return t.includes(',')?`"${t.replace(/"/g,'""')}"`:t;
    }).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='carga_masiva.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  $('#cmv_push')?.addEventListener('click', async ()=>{
    const rows=$$('#cmv_tbody tr');
    if(!rows.length) return alert('No hay filas.');
    const cur=getCur();
    const allowDec=(cur==='USD'||cur==='PEN');
    const parseForAPI=(v)=>{
      const raw=String(v||'');
      if(!allowDec){ const d=raw.replace(/[^\d]/g,''); return d?parseInt(d,10):0; }
      const lastSep=Math.max(raw.lastIndexOf(','),raw.lastIndexOf('.'));
      if(lastSep<0){ const d=raw.replace(/[^\d]/g,''); return d?parseInt(d,10):0; }
      const L=raw.slice(0,lastSep).replace(/[^\d]/g,'');
      const R=raw.slice(lastSep+1).replace(/[^\d]/g,'').slice(0,2);
      const i=L?parseInt(L,10):0; const f=R?parseInt(R,10)/Math.pow(10,R.length):0;
      return +(i+f).toFixed(2);
    };
    let ok=0, fail=0;
    for(const tr of rows){
      const val=(c)=> tr.querySelector(`[data-col="${c}"]`)?.value?.trim() || '';
      const payload={
        rut: val('rut'),
        razon_social: val('razon_social'),
        periodo: val('periodo'),
        tipo_instrumento: val('tipo_instrumento'),
        folio: val('folio'),
        monto: parseForAPI(val('monto')),
        moneda: cur,
        estado_validacion: val('estado_validacion'),
        observaciones: val('observaciones'),
      };
      try{
        const res=await fetch('/api/calificaciones/',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(res.ok) ok++; else fail++;
      }catch(e){ fail++; }
    }
    alert(`Env√≠o completado. OK: ${ok} ‚Ä¢ Error: ${fail} ‚Ä¢ Moneda: ${cur}`);
  });

})();
}catch(e){ console.error('[carga-masiva] fallo:', e); }
</script>
{% endblock %}
