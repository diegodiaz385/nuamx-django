{% extends "web/_base.html" %}

{% block html_title %}NUAMX â€“ Carga masiva{% endblock %}
{% block page_title %}Carga masiva{% endblock %}
{% block page_subtitle %}Descarga el formato Excel, complÃ©talo y sÃºbelo para validar. Si todo estÃ¡ OK, confÃ­rmalo para crear en la base real.{% endblock %}

{% block extra_head %}
<style>
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff;font-size:.85rem}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;table-layout:fixed;font-size:14px}
  thead th{background:#f8fafc;font-weight:600;border-bottom:1px solid var(--border)}
  th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
  thead th, tbody td{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .input,.select,.textarea{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font:inherit;background:#fff;min-height:32px}
  .input.text-right{text-align:right}
  .textarea{white-space:normal;resize:none;line-height:1.25;min-height:32px}
  .row-actions button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:4px 10px;font-size:13px;white-space:nowrap}
  .err{color:#991b1b;background:#fee2e2;border-color:#fecaca}
  .hint{font-size:.9rem;color:var(--muted)}

  /* anchos compactos */
  table.compact thead th:nth-child(1), table.compact tbody td:nth-child(1){width:110px;}  /* RUT */
  table.compact thead th:nth-child(2), table.compact tbody td:nth-child(2){width:160px;}  /* RazÃ³n social */
  table.compact thead th:nth-child(3), table.compact tbody td:nth-child(3){width:100px;}  /* PerÃ­odo */
  table.compact thead th:nth-child(4), table.compact tbody td:nth-child(4){width:118px;}  /* Tipo */
  table.compact thead th:nth-child(5), table.compact tbody td:nth-child(5){width:95px;}   /* Folio */
  table.compact thead th:nth-child(6), table.compact tbody td:nth-child(6){width:120px;}  /* Monto */
  table.compact thead th:nth-child(7), table.compact tbody td:nth-child(7){width:95px;}   /* Moneda */
  table.compact thead th:nth-child(8), table.compact tbody td:nth-child(8){width:120px;}  /* Estado */
  table.compact thead th:nth-child(9), table.compact tbody td:nth-child(9){width:170px;white-space:normal;} /* Observaciones */
  table.compact thead th:nth-child(10), table.compact tbody td:nth-child(10){width:100px;} /* Acciones */

  td > .input, td > .select, td > .textarea { width:100%; box-sizing:border-box; }
  thead th{white-space:normal; line-height:1.1}
  .btn[disabled], .btn-ghost[disabled]{opacity:.6; pointer-events:none}
</style>
{% endblock %}

{% block content %}
<section class="card p-6 space-y-4">

  <div class="toolbar">
    <div class="flex items-center gap-3">
      <button id="btn_add_row" class="btn-ghost" type="button">âž• Agregar fila</button>
      <a id="btn_template" href="#" class="btn-ghost">â¬‡ Descargar formato (XLSX)</a>
      <label class="btn-ghost" style="cursor:pointer">
        ðŸ“¤ Cargar formatoâ€¦
        <input id="file_input" type="file" accept=".xlsx" style="display:none">
      </label>
      <button id="btn_preview" class="btn" type="button">âœ… Validar</button>
      <button id="btn_export_xlsx" class="btn-ghost" type="button">â¬‡ Exportar Excel (XLSX)</button>
      <button id="btn_commit" class="btn" type="button">ðŸ“¡ Subir a API</button>
    </div>

    <div class="flex items-center gap-3">
      <span id="badge_rows" class="pill">0 filas</span>
      <span id="badge_errors" class="pill">0 errores</span>
      <span id="busy" class="pill" style="display:none">Procesandoâ€¦</span>
    </div>
  </div>

  <div class="hint">Reglas: <strong>CLP</strong> y <strong>COP</strong> sin decimales; <strong>USD</strong> y <strong>PEN</strong> con <em>coma</em> decimal y hasta 2 decimales.</div>

  <div class="table-wrap">
    <table id="table_bulk" class="compact">
      <thead>
        <tr>
          <th>RUT</th>
          <th>RazÃ³n social</th>
          <th>PerÃ­odo</th>
          <th>Tipo</th>
          <th>Folio</th>
          <th>Monto</th>
          <th>Moneda</th>
          <th>Estado</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody_bulk"></tbody>
    </table>
  </div>

  <p id="empty" class="muted">AÃºn no hay filas. Descarga el formato o agrega filas manualmente.</p>
  <div id="inline_err" class="err pill" style="display:none"></div>

</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  if (window.__NUAMX_CM_BOUND__) return;
  window.__NUAMX_CM_BOUND__ = true;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const doFetch = (u,init)=> (window.authFetch ? authFetch(u,init) : fetch(u,init));

  /* ===== helpers de dinero por fila ===== */
  function supportsCents(code){
    const c = String(code||'').toUpperCase();
    return c==='USD' || c==='PEN';
  }
  // Live: no miles para no romper caret. CLP/COP enteros; USD/PEN coma y 2 dec.
  function formatLiveByCurrency(text, code){
    const allow = supportsCents(code);
    const s = String(text ?? '').trim();
    if(!allow){
      return s.replace(/[^\d]/g,'');
    }
    let raw = s.replace(/[^\d,]/g,'');
    if(!raw) return '';
    const first = raw.indexOf(',');
    if(first !== -1){
      raw = raw.slice(0, first + 1) + raw.slice(first + 1).replace(/,/g,'');
    }
    const parts = raw.split(',');
    const L = (parts[0] || '').replace(/[^\d]/g,'');
    let out = L.replace(/^0+(\d)/,'$1');
    if(parts.length > 1){
      const R = (parts[1] || '').replace(/[^\d]/g,'').slice(0,2);
      out = out || '0';
      out += R.length ? (',' + R) : ',';
    }
    return out;
  }
  // Blur: completa ,00 si falta para USD/PEN
  function formatBlurByCurrency(text, code){
    if(!supportsCents(code)) return (String(text||'').replace(/[^\d]/g,'')) || '';
    const s = String(text||'').trim();
    if(!s) return '';
    if(!s.includes(',')) return s + ',00';
    const [L, R=''] = s.split(',');
    if(R === '') return L + ',00';
    if(R.length === 1) return L + ',' + R + '0';
    return L + ',' + R.slice(0,2);
  }

  /* ===== estado ===== */
  let rows = [];
  const TB = $('#tbody_bulk');
  const EMPTY = $('#empty');
  const ERR = $('#inline_err');

  function setBusy(v){ $('#busy').style.display = v? '':'none'; }
  function showErr(m){ ERR.style.display=''; ERR.textContent=m||'Error'; }
  function hideErr(){ ERR.style.display='none'; ERR.textContent=''; }

  // Fila vacÃ­a sin defaults
  function emptyRow(){
    return {
      rut:'', razon_social:'', periodo:'', tipo:'', folio:'',
      monto:'', moneda:'', estado:'', observaciones:'',
      tipo_instrumento:'', monto_raw:'',
      _errors:[]
    };
  }

  function paint(){
    TB.innerHTML='';
    rows.forEach((r,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="input" data-f="rut" value="${r.rut||''}" placeholder="11.111.111-1"></td>
        <td><input class="input" data-f="razon_social" value="${r.razon_social||''}" placeholder="Empresa SpA"></td>
        <td><input class="input" data-f="periodo" value="${r.periodo||''}" placeholder="YYYY-MM"></td>
        <td>
          <select class="select" data-f="tipo">
            <option value="">Seleccionaâ€¦</option>
            <option ${r.tipo==='Factura'?'selected':''}>Factura</option>
            <option ${r.tipo==='Boleta'?'selected':''}>Boleta</option>
            <option ${r.tipo==='Nota de crÃ©dito'?'selected':''}>Nota de crÃ©dito</option>
            <option ${r.tipo==='Otro'?'selected':''}>Otro</option>
          </select>
        </td>
        <td><input class="input" data-f="folio" value="${r.folio||''}" placeholder="F-123"></td>
        <td><input class="input text-right" data-money="1" data-f="monto" value="${r.monto||''}" placeholder="0"></td>
        <td>
          <select class="select" data-f="moneda">
            <option value="">Seleccionaâ€¦</option>
            <option value="CLP" ${r.moneda==='CLP'?'selected':''}>CLP</option>
            <option value="USD" ${r.moneda==='USD'?'selected':''}>USD</option>
            <option value="COP" ${r.moneda==='COP'?'selected':''}>COP</option>
            <option value="PEN" ${r.moneda==='PEN'?'selected':''}>PEN</option>
          </select>
        </td>
        <td>
          <select class="select" data-f="estado">
            <option value="">Seleccionaâ€¦</option>
            <option ${r.estado==='VÃ¡lida'?'selected':''}>VÃ¡lida</option>
            <option ${r.estado==='Con advertencias'?'selected':''}>Con advertencias</option>
            <option ${r.estado==='Rechazada'?'selected':''}>Rechazada</option>
          </select>
        </td>
        <td><textarea class="textarea" rows="1" data-f="observaciones" placeholder="Notasâ€¦">${r.observaciones||''}</textarea></td>
        <td class="row-actions"><button data-act="del" data-idx="${idx}">Eliminar</button></td>`;
      if(r._errors?.length){ tr.title=r._errors.join(' | '); tr.classList.add('err'); }
      TB.appendChild(tr);
    });
    $$('#tbody_bulk textarea[data-f="observaciones"]').forEach(el=>{
      el.style.height='auto'; el.style.height=el.scrollHeight+'px';
    });
    $('#badge_rows').textContent=`${rows.length} fila${rows.length!==1?'s':''}`;
    $('#badge_errors').textContent=`${rows.reduce((a,b)=>a+(b._errors?.length||0),0)} errores`;
    EMPTY.style.display=rows.length?'none':'';
  }

  /* ediciÃ³n */
  TB.addEventListener('keydown', e=>{
    const inp=e.target.closest('input[data-money]'); if(!inp) return;
    const tr=inp.closest('tr'); const idx=Array.from(TB.children).indexOf(tr);
    const cur=rows[idx]?.moneda||'';
    if(supportsCents(cur) && (e.key==='.' || e.key===',')){
      e.preventDefault();
      const start = inp.selectionStart ?? inp.value.length;
      const end   = inp.selectionEnd ?? inp.value.length;
      const v = inp.value;
      const before = v.slice(0,start);
      const after  = v.slice(end);
      let next = before + ',' + after;
      next = formatLiveByCurrency(next, cur);
      inp.value = next;
      const pos = (before + ',').length;
      try{ inp.setSelectionRange(pos,pos); }catch(_){}
      rows[idx].monto = next; rows[idx].monto_raw = next; rows[idx]._errors=[];
    }
  });

  TB.addEventListener('input', e=>{
    const el=e.target.closest('input,select,textarea'); if(!el) return;
    const tr=el.closest('tr'); const idx=Array.from(TB.children).indexOf(tr);
    const f=el.getAttribute('data-f');

    if(f==='monto' && el.hasAttribute('data-money')){
      const cur=rows[idx].moneda||'';
      el.value = formatLiveByCurrency(el.value, cur);
      rows[idx].monto = el.value;
      rows[idx].monto_raw = el.value;
    }else{
      rows[idx][f] = el.value;
      if(f==='tipo') rows[idx].tipo_instrumento = el.value;
      if(f==='observaciones'&&el.tagName==='TEXTAREA'){
        el.style.height='auto'; el.style.height=el.scrollHeight+'px';
      }
    }
    rows[idx]._errors=[];
  });

  TB.addEventListener('blur', e=>{
    const inp=e.target.closest('input[data-money]'); if(!inp) return;
    const tr=inp.closest('tr'); const idx=Array.from(TB.children).indexOf(tr);
    const cur=rows[idx].moneda||'';
    inp.value = formatBlurByCurrency(inp.value, cur);
    rows[idx].monto = inp.value;
    rows[idx].monto_raw = inp.value;
  }, true);

  TB.addEventListener('change', e=>{
    const sel=e.target.closest('select[data-f="moneda"]'); if(!sel) return;
    const tr=e.target.closest('tr'); const idx=Array.from(TB.children).indexOf(tr);
    const cur = sel.value || '';
    rows[idx].moneda = cur;
    const money=tr.querySelector('input[data-f="monto"]');
    if(money){
      money.value = formatLiveByCurrency(money.value, cur);
      rows[idx].monto = money.value;
      rows[idx].monto_raw = money.value;
    }
  });

  TB.addEventListener('click', e=>{
    const b=e.target.closest('button[data-act="del"]'); if(!b) return;
    const idx=parseInt(b.getAttribute('data-idx'),10); rows.splice(idx,1); paint();
  });

  $('#btn_add_row').addEventListener('click', ()=>{ rows.push(emptyRow()); paint(); });

  /* descarga plantilla */
  async function authDownload(url,filename){
    try{
      const r=await doFetch(url,{credentials:'include'});
      if(!r.ok){ showErr('No se pudo descargar la plantilla ('+r.status+').'); return; }
      const blob=await r.blob();
      const a=document.createElement('a');
      const u=URL.createObjectURL(blob);
      a.href=u; a.download=filename||'plantilla_carga_masiva.xlsx';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
    }catch{ showErr('Error de red al descargar la plantilla.'); }
  }
  $('#btn_template').addEventListener('click', ev=>{
    ev.preventDefault();
    authDownload('/api/calificaciones/template/','plantilla_carga_masiva.xlsx');
  });

  /* subir XLSX */
  function setButtonsDisabled(v){ $('#btn_preview').disabled=v; $('#btn_commit').disabled=v; }

  $('#file_input').addEventListener('change', async ()=>{
    hideErr();
    const f=$('#file_input').files[0]; if(!f) return;
    const fd=new FormData(); fd.append('file',f);
    setBusy(true); setButtonsDisabled(true);
    try{
      const r=await doFetch('/api/calificaciones/import_preview/',{method:'POST',body:fd});
      if(!r.ok){ showErr('No se pudo validar el archivo.'); return; }
      const data=await r.json();
      rows=(data.rows||[]).map(x=>{
        const out = {
          rut: x.rut ?? x.RUT ?? '',
          razon_social: x.razon_social ?? x['RazÃ³n social'] ?? '',
          periodo: x.periodo ?? x.PerÃ­odo ?? '',
          tipo: x.tipo ?? x.Tipo ?? x.tipo_instrumento ?? '',
          folio: x.folio ?? x.Folio ?? '',
          monto: String(x.monto ?? x.Monto ?? x.monto_raw ?? '').trim(),
          moneda: (x.moneda ?? x.Moneda ?? '').toString().toUpperCase(),
          estado: x.estado ?? x.Estado ?? x.estado_validacion ?? '',
          observaciones: x.observaciones ?? x.Observaciones ?? '',
          _errors: x.errors || []
        };
        out.tipo_instrumento = out.tipo;
        out.monto_raw = out.monto;
        out.monto = formatLiveByCurrency(out.monto, out.moneda);
        out.monto_raw = out.monto;
        return out;
      });
      paint();
      if(data.errors?.length) showErr(data.errors.join(' | '));
    }catch{ showErr('Error de red al validar archivo.'); }
    finally{ setBusy(false); setButtonsDisabled(false); }
  });

  /* ====== Exportar: XLSX (POST filas actuales) con fallback a CSV ====== */
  function exportCSVFallback(){
    const rowsOut = [['RUT','RazÃ³n social','PerÃ­odo','Tipo','Folio','Monto','Moneda','Estado','Observaciones']];
    rows.forEach(r=>{
      rowsOut.push([r.rut,r.razon_social,r.periodo,r.tipo,r.folio,r.monto,r.moneda,r.estado,r.observaciones]);
    });
    const csv = rowsOut.map(r=>r.map(v=>{
      const s=String(v??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
    }).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='carga_masiva.csv'; a.click(); URL.revokeObjectURL(url);
  }

  async function exportXLSX(){
    if(!rows.length){ showErr('No hay filas para exportar.'); return; }
    hideErr(); setBusy(true);
    try{
      const payload = {
        // MISMAS CABECERAS Y CAMPOS QUE EL EXCEL
        rows: rows.map(r => ({
          rut: r.rut,
          "RazÃ³n social": r.razon_social,
          periodo: r.periodo,
          tipo: r.tipo,
          folio: r.folio,
          monto: r.monto,          // mantener como estÃ¡ en UI
          moneda: r.moneda,
          estado: r.estado,
          observaciones: r.observaciones
        }))
      };
      const r = await doFetch('/api/calificaciones/export_xlsx_from_rows/',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!r.ok){
        // si el backend aÃºn no estÃ¡ con POST habilitado, fallback a CSV
        exportCSVFallback();
        showErr('No se pudo exportar XLSX. Se exportÃ³ CSV como respaldo.');
        return;
      }
      const blob = await r.blob();
      const a = document.createElement('a');
      const u = URL.createObjectURL(blob);
      a.href = u; a.download = 'carga_masiva.xlsx';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
    }catch(e){
      exportCSVFallback();
      showErr('Error al exportar XLSX. Se exportÃ³ CSV como respaldo.');
    }finally{
      setBusy(false);
    }
  }

  document.getElementById('btn_export_xlsx').addEventListener('click', exportXLSX);

  /* payloads para preview/commit */
  function buildPayload(periodoForm /* 'as_is' | 'dash' | 'plain' */){
    return {
      rows: rows.map(r=>{
        let periodo = r.periodo;
        if(periodoForm==='dash'){
          const m=String(r.periodo||'').match(/^(\d{4})(\d{2})$/);
          if(m) periodo=`${m[1]}-${m[2]}`;
        }
        if(periodoForm==='plain'){
          const m=String(r.periodo||'').match(/^(\d{4})-(\d{1,2})/);
          if(m){ periodo=`${m[1]}${String(m[2]).padStart(2,'0')}`; }
        }
        return {
          rut: r.rut,
          razon_social: r.razon_social,
          periodo,
          tipo: r.tipo,
          folio: r.folio,
          monto: r.monto,
          moneda: r.moneda,
          estado: r.estado,
          observaciones: r.observaciones,
          tipo_instrumento: r.tipo,
          monto_raw: r.monto,
          estado_validacion: r.estado
        };
      })
    };
  }

  async function postJSON(url,payload){
    const r=await doFetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const text=await r.text(); return {ok:r.ok,text};
  }
  function applyRowErrors(json){
    (json.rows||[]).forEach((rr,i)=>{ rows[i]._errors=rr.errors||[]; });
    $('#badge_errors').textContent=`${rows.reduce((a,b)=>a+(b._errors?.length||0),0)} errores`;
    paint();
  }
  function looksPeriodo(t){
    try{
      const j=(typeof t==='string')?JSON.parse(t):t;
      const s=((j?.errors)||[]).join(' ').toLowerCase()+' '+((j?.rows)||[]).map(x=>(x.errors||[]).join(' ')).join(' ').toLowerCase();
      return /periodo|perÃ­odo|yyyy-?mm/.test(s);
    }catch{
      return /periodo|perÃ­odo|yyyy-?mm/i.test(String(t||''));
    }
  }

  /* validar */
  $('#btn_preview').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    if(!rows.length){ showErr('No hay filas para validar.'); return; }
    hideErr(); setBusy(true); $('#btn_preview').disabled=true; $('#btn_commit').disabled=true;
    try{
      let res = await postJSON('/api/calificaciones/import_preview/', buildPayload('as_is'));
      if(!res.ok){ showErr(res.text.slice(0,800)); return; }
      let data={}; try{ data=JSON.parse(res.text);}catch{ data={errors:['Respuesta no JSON']}; }
      applyRowErrors(data);
      if(looksPeriodo(data)){
        let res2 = await postJSON('/api/calificaciones/import_preview/', buildPayload('plain'));
        if(res2.ok){ let d2={}; try{ d2=JSON.parse(res2.text);}catch{} applyRowErrors(d2); if(d2.errors?.length) showErr(d2.errors.join(' | ')); }
      }else if(data.errors?.length){ showErr(data.errors.join(' | ')); }
    }finally{ setBusy(false); $('#btn_preview').disabled=false; $('#btn_commit').disabled=false; }
  });

  /* commit */
  $('#btn_commit').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    if(!rows.length){ showErr('No hay filas para subir.'); return; }
    if(rows.some(r=>r._errors?.length)){ showErr('Corrige los errores antes de subir.'); return; }
    hideErr(); setBusy(true); $('#btn_preview').disabled=true; $('#btn_commit').disabled=true;
    try{
      let res = await postJSON('/api/calificaciones/import_commit/', buildPayload('as_is'));
      if(!res.ok){
        if(looksPeriodo(res.text)){
          let res2 = await postJSON('/api/calificaciones/import_commit/', buildPayload('plain'));
          if(!res2.ok){ showErr(res2.text.slice(0,800)); return; }
          let d2={}; try{ d2=JSON.parse(res2.text);}catch{}
          rows=[]; paint(); alert(`Subida exitosa. Creados: ${d2.created||0}`); return;
        }
        showErr(res.text.slice(0,800)); return;
      }
      let data={}; try{ data=JSON.parse(res.text);}catch{}
      rows=[]; paint(); alert(`Subida exitosa. Creados: ${data.created||0}`);
    }finally{ setBusy(false); $('#btn_preview').disabled=false; $('#btn_commit').disabled=false; }
  });

  paint();
})();
</script>
{% endblock %}
